<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8"/>
	<title>EasyScore - jqm protótipo</title>
	
	
	<!-- SCRIPTS VEXXX MUSICXML -->
<!-- VexFlow Sources -->
<script src="src/vex.js"></script>
<script src="src/flow.js"></script>
<script src="src/fraction.js"></script>
<script src="src/fonts/vexflow_font.js"></script>
<script src="src/glyph.js"></script>
<script src="src/tables.js"></script>
<script src="src/stave.js"></script>
<script src="src/staveconnector.js"></script>
<script src="src/voice.js"></script>
<script src="src/voicegroup.js"></script>
<script src="src/modifier.js"></script>
<script src="src/modifiercontext.js"></script>
<script src="src/accidental.js"></script>
<script src="src/dot.js"></script>
<script src="src/tickcontext.js"></script>
<script src="src/tickable.js"></script>
<script src="src/note.js"></script>
<script src="src/bend.js"></script>
<script src="src/stem.js"></script>
<script src="src/notehead.js"></script>
<script src="src/stemmablenote.js"></script>
<script src="src/stavenote.js"></script>
<script src="src/tabnote.js"></script>
<script src="src/barnote.js"></script>
<script src="src/clefnote.js"></script>
<script src="src/timesignote.js"></script>
<script src="src/ghostnote.js"></script>
<script src="src/formatter.js"></script>
<script src="src/stavetie.js"></script>
<script src="src/stavehairpin.js"></script>
<script src="src/tabtie.js"></script>
<script src="src/tabslide.js"></script>
<script src="src/beam.js"></script>
<script src="src/vibrato.js"></script>
<script src="src/annotation.js"></script>
<script src="src/tuning.js"></script>
<script src="src/stavemodifier.js"></script>
<script src="src/keysignature.js"></script>
<script src="src/timesignature.js"></script>
<script src="src/clef.js"></script>
<script src="src/music.js"></script>
<script src="src/keymanager.js"></script>
<script src="src/renderer.js"></script>
<script src="src/stavebarline.js"></script>
<script src="src/stavevolta.js"></script>
<script src="src/staverepetition.js"></script>
<script src="src/stavesection.js"></script>
<script src="src/stavetempo.js"></script>
<script src="src/stavetext.js"></script>
<script src="src/raphaelcontext.js"></script>
<script src="src/canvascontext.js"></script>
<script src="src/tuplet.js"></script>
<script src="src/boundingbox.js"></script>
<script src="src/textnote.js"></script>

<script src="src/measure.js"></script>
<script src="src/musicxml.js"></script>
<script src="src/document.js"></script>
<script src="src/documentformatter.js"></script>

<!-- Test Sources -->
<script src="js/part_complete.js"></script>
<script src="js/part_simples.js"></script>
<script src="js/part_duas_pautas.js"></script>
<script src="js/part_ishigo_nocom.js"></script>

<link rel="stylesheet" href="js/qunit.css" type="text/css"
	media="screen" />
<script src="js/jquery.js"></script>
<script src="js/qunit.js"></script>
<script src="js/teste.js"></script>
<!-- END OF MUSICXML -->
	
	
	<link rel="stylesheet" href="css/jquery.mobile-1.4.3.min.css">
	<link rel="stylesheet" href="css/jqm-demos.css">
	<link rel="shortcut icon" href="img/__logo.png">
	<script src="js/jquery.mobile-1.4.3.min.js"></script>
	<!--script src="js/websocketTime.js"></script-->
	<script src="js/websocket.js"></script>
	
	<script>
		var i = 0;
		var timeoutvar;
		
		$(function(){
			$( "[data-role='header'], [data-role='footer']" ).toolbar();
		});
	</script>
	<script id="panel-init">
		$(function () {
		  $("[data-role=panel]").panel().enhanceWithin();
		});
	</script>
	
	<!-- script src="http://192.168.0.8:8080/target/target-script-min.js#anonymous"></script -->
<style text="text/css">
#exibePart {
	background-color: #eed;
	background: #eed;
}

#exibe_info {
	background-color: #eed;
	background: #eed;
}

canvas {
	background: #eed;
}

div.egcode {
	font-family: Courier;
	font-size: 14px;
}

footer {
	padding: 10px;
}

#container {
	border: 1px solid #ccc; height: 100px; overflow: scroll; width: 100px;
}
</style>
</head>

<body>
<!-- class="ui-mobile-viewport ui-overlay-a ui-panel-page-container-themed ui-panel-page-container" -->
	
<!-- Start of first page: #one -->
<div data-role="page" id="mainpage" data-footer="div_footer">
	<div data-role="header">
		<h1>EasyScore</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->
	
	<div role="main" class="ui-content">
		<ul data-role="listview" data-inset="true" id="listaEstudios">
			<li><a href="#selecionaPart">Estúdio 1</a></li>
			<li><a href="#selecionaPart">Estúdio 2</a></li>
			<li><a href="#selecionaPart">Estúdio 3</a></li>
		</ul>
		<br/>
		<br/>
		<p><a href="#selecionaExemplo" class="ui-btn ui-shadow ui-corner-all" data-rel="dialog" data-transition="pop">Seleciona Exemplo</a></p>
		<br/>
	</div><!-- /content -->
	
</div><!-- /page one -->

<!-- Start of second page: #upload -->
<div data-role="page" id="upload" data-theme="a" data-footer="div_footer">

	<div data-role="header">
		<h1>Carregar Partitura</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<br />
		<input id="nome_part" type="text" placeholder="nome da partitura" />
		<input id="arquivo" type="text" placeholder="caminho do arquivo" />
		<a class="ui-btn" id="btn_upload" href="#mainpage">Enviar</a>
		<br/>
		<br/>
		<a class="ui-btn" id="btn_le" href="#">Lê Arquivo</a>
		<textarea id="res_botao" rows="10" cols="50"></textarea>
	</div><!-- /content -->

</div><!-- /page upload -->

<!-- Start of third page: #criaEstudio -->
<div data-role="page" id="criaEstudio" data-footer="div_footer">

	<div data-role="header">
		<h1>Criar Estúdio</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<fieldset class="ui-grid-a">
			<div class="ui-block-a">
				<label>Nome do Estúdio</label>
				<input type="text" required id="criaEstName"/>
			</div>
			<div class="ui-block-b" style="width: 200px; padding-left:10px">
				<label>Horário de Início</label>
				<input type="time" required id="criaEstStart"/>
			</div>
		</fieldset>
		<label>Velocidade de execução da música</label>
		<input type="range" min="1" max="20" value="6" step="0.5" id="criaEstSpeed" />
		<a class="ui-btn" href="#selecionaPartEst" id="btn_criaEstudio">Criar</a>
	</div><!-- /content -->
</div><!-- /page criaEstudio -->

<!-- Start of page: #selecionaPartEst MAESTRO -->
<div data-role="page" id="selecionaPartEst" data-footer="div_footer">

	<div data-role="header">
		<h1>Estúdio</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<form>
		<fieldset data-role="controlgroup">
			<legend>Escolha as partituras:</legend>
			<input name="est_1" id="est_1" type="checkbox">
			<label for="est_1">Estúdio 1 - Partitura 1</label>
			<input name="est_2t" id="est_2t" type="checkbox">
			<label for="est_2t">Estúdio 2 - Tuba</label>
			<input name="est_2c" id="est_2c" type="checkbox">
			<label for="est_2c">Estúdio 2 - Clarinete</label>
			<input name="est_2s" id="est_2s" type="checkbox">
			<label for="est_2s">Estúdio 2 - Saxofone</label>
			<input name="est_3c" id="est_3c" type="checkbox">
			<label for="est_3c">Estúdio 3 - Clarinete</label>
		</fieldset>
		</form>
		<a class="ui-btn" id="btn_selec" href="#mainpage">Selecionar</a>
		<br/>
		<br/>
		<label for="search-control-group">Search</label>
		<div data-role="controlgroup" data-type="horizontal">
			<input id="search-control-group" data-wrapper-class="controlgroup-textinput ui-btn" type="text">
			<!--button id="submit" onclick="adicionarcheck">Submit</button-->
		</div>
	</div><!-- /content -->
</div><!-- /page selecionaPartEst MAESTRO -->

<!-- Start of page: #selecionaPart -->
<div data-role="page" id="selecionaPart" data-footer="div_footer">

	<div data-role="header">
		<h1 id='selecionaPartH1'>Estudio</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<ul data-role="listview" data-inset="true" id="listaPart">
			<li>Estúdio - Partitura 1</li>
		</ul>
		<a class="ui-btn" id="btn_selecionaPart" href="#mainpage">Receber</a>
		<br/>
	</div><!-- /content -->
	
</div><!-- /page selecionaPart -->

<!-- Start of page: #configuracoes -->
<div data-role="page" id="configuracoes" data-footer="div_footer">

	<div data-role="header">
		<h1>Configurações</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<br />
		<br />
		<label>Escala da Partitura</label>
		<input type="range" min="1" max="8" value="3" step="0.5" id="rangeEscala" />
		<br/>
		<br/>
		<label>Velocidade</label>
		<input type="range" min="1" max="20" value="6" step="0.5" id="rangeVelocidade" />
		<br/>
		<br/>
		<button id="btn_configuracoes">Gravar</button>
	</div><!-- /content -->
</div><!-- /page configuracoes -->

<!-- Start of page: #selecionaPart -->
<div data-role="page" id="selecionaPart" data-footer="div_footer">

	<div data-role="header">
		<h1>Estúdio</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<ul data-role="listview" data-inset="true" id="listaPart">
			<li>Estúdio - Partitura 1</li>
		</ul>
		<a class="ui-btn" id="btn_notificar" href="#exibePart">Começar</a>
	</div><!-- /content -->
	
</div><!-- /page selecionaPart -->

<!-- Start of page: #selecionaExemplo -->
<div data-role="page" id="selecionaExemplo" data-footer="div_footer">

	<div data-role="header">
		<h1>Exemplos</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<form name = "radiosForm">
			<fieldset data-role="controlgroup" id="checkExample">
				<legend>Escolha o exemplo:</legend>
				<input name="radio-choice-v-2" id="echigo" value="on" checked="checked" type="radio">
				<label for="echigo">Echigo-Jish</label>
				<input name="radio-choice-v-2" id="dupla" value="off" type="radio">
				<label for="dupla">Dupla</label>
				<input name="radio-choice-v-2" id="simples" value="other" type="radio">
				<label for="simples">Simples</label>
			</fieldset>
		</form>
		
		<a class="ui-btn" id="btn_comecarExemplo" href="#exibePart">Começar</a>
	</div><!-- /content -->
</div><!-- /page selecionaExemplo -->

<!-- Start of page: #exibePart -->
<div data-role="page" id="exibePart" data-footer="div_footer">

	<div data-role="header">
		<h1>Estúdio</h1>
		<a href="#panel_options" data-icon="gear" data-iconpos="notext" class="ui-btn-right"></a>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<div id="exibe_info" class="upage-content" style="overflow: auto">
			<div id="vexflow">
				<br />
			</div>
		</div>
		<a class="ui-btn" id="btn_voltaMain" href="#mainpage">Voltar e Limpar</a>
		<button id="btn_pause" style="display: block">Pausar</button>
		<button id="btn_continue" style="display: none">Continuar</button>
	</div><!-- /content -->
</div><!-- /page exibePart -->

<div data-role="footer" id="div_footer">
	<h4>EasyScore</h4>
</div><!-- /footer -->

<div data-role="panel" data-position="right" data-theme="a" data-display="overlay" id="panel_options">
	<div class="content">
		<ul data-inset="true" data-theme="a" data-icon="false" data-role="listview">
			<li data-icon="back" data-role="list-divider"><a href="#" data-rel="close">Voltar</a></li>
			<li id="consultarEstudios"><a href="#mainpage">Consultar Estúdios</a></li>
			<li><a href="#upload">Carregar Partitura</a></li>
			<li><a href="#criaEstudio">Criar Estúdio</a></li>
			<li><a href="#configuracoes">Configurações</a></li>
			<li><a href="#selecionaExemplo">Exemplos de Partituras</a></li>
		</ul>
	</div>
</div>

<script>
	var doc;
	var formatter;
	var escPart = 3.0;
	var velPart = 500; //timeout de 3 segundos
	var d = new Date();
	var studioid;
	
	function setDoc() {
		var comp;

		if (document.getElementById("echigo").checked) {
			comp = ishigo;
		} else if (document.getElementById("dupla").checked) {
			comp = part_dupla;
		} else {
			comp = part_simples;
		}
	
		doc = new Vex.Flow.Document(comp);
		formatter = doc.getFormatter();
		formatter.zoom = escPart;
		console.log("número de compassos da partitura: " + doc.getNumberOfMeasures());
		//alert(formatter.measuresInBlock[0].length);
		formatter.setWidth(doc.getNumberOfMeasures() * 150);	
	}
	
	var main = function() {
		init();
		//listaestudios = está no websocket.js, no onMessage (obj.hasOwnProperty('studios'))
		$('#btn_comecarExemplo').click(function() {
			setDoc();
			drawLine();
			
			var nBlocks = doc.getNumberOfMeasures() * 100;
			console.log("DENTRO DO BOTÃO: número de compassos da partitura: " + doc.getNumberOfMeasures() + "    " + nBlocks);
			document.getElementById('exibe_info').scrollLeft = -500;
			scrollBlocksIntoView(nBlocks, velPart);
		});
		$('#btn_voltaMain').click(function() {
			var b = 0;
			while (typeof formatter.canvases[b] == "object") {
				// Remove canvases beyond the last one we are using
				document.getElementById('vexflow').removeChild(formatter.canvases[b]);
				delete formatter.canvases[b];
				b++;
			  }
		});
		$('#btn_configuracoes').click(function() {
			escPart = document.getElementById("rangeEscala").value;
			velPart = (1/(document.getElementById("rangeVelocidade").value)) * 3000; //inversamente proporcional
		});
		$('#btn_pause').click(function() {
			document.getElementById('btn_pause').style.display="none";
			document.getElementById('btn_continue').style.display="block";
			clearTimeout(timeoutvar);
		});
		$('#btn_continue').click(function() {
			document.getElementById('btn_pause').style.display="block";
			document.getElementById('btn_continue').style.display="none";
			var nBlocks = doc.getNumberOfMeasures() * 100;
			scrollBlocksIntoView(nBlocks, velPart);
		});
		$('#btn_criaEstudio').click(function() {
			var speed = document.getElementById('criaEstSpeed').value;
			speed = (1/document.getElementById('criaEstSpeed').value) * 3000;
			var start = document.getElementById('criaEstStart').value;
			var name = document.getElementById('criaEstName').value;
			var d = new Date();
			d.setMinutes(start.substr(3,5));
			d.setHours(start.substr(0,2));
			alert("Início: " + start + " date: " + d + " - getTime: " + d.getTime() + 
				'\nNome: ' + name + '\nVelocidade: ' + speed);
			
			createStudio(name, d.getTime(), speed);
		});
		$('#btn_upload').click(function() {
			//envia a partitura informada para o servidor
			var nomePart = document.getElementById("nome_part").value;
			readFile(document.getElementById("arquivo").value); //"EasyScore/chant.xml"
			sendScore(1, nomePart, partitura_lida);
		});
		$('#btn_le').click(function() {
			//envia a partitura informada para o servidor
			readFile(document.getElementById("arquivo").value);
		});
	}
	
	function scrollBlocksIntoView(numberOfBlocks, timeout) {
		console.log("number of blocks" + numberOfBlocks);
		function cb() {
			document.getElementById('exibe_info').scrollLeft += 20;
			i++;
			if (i%1000===0) console.log(i + " scroll: " + document.getElementById('exibe_info').scrollLeft + " - timeout: " + timeout);
			if (i < numberOfBlocks) timeoutvar = setTimeout(cb, timeout);
			if ( $('#exibe_info').scrollLeft() >= ($('#exibe_info canvas').width() - $('#exibe_info').width()) && i > 3) {
				clearTimeout(timeoutvar);
				i = 0;
			}
		}
		cb();
	};
	
	$(document).ready(main);
</script>
</body>
</html>